<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cursor Agent - Realworld Agent</title>
  <link rel="stylesheet" href="/styles.css">
  <style>
    body {
      margin: 0;
      overflow: hidden;
    }

    /* Layout with Sidebar */
    .app-layout {
      display: flex;
      height: calc(100vh - 60px);
      position: relative;
    }

    /* Sidebar Styles */
    .sidebar {
      width: 280px;
      background: var(--surface-color);
      border-right: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      transition: transform 0.3s ease;
      overflow: hidden;
      position: relative;
      z-index: 100;
    }

    .sidebar.collapsed {
      transform: translateX(-280px);
    }

    .sidebar-header {
      padding: 20px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .sidebar-header h3 {
      color: var(--accent-color);
      font-size: 1.1rem;
      margin: 0;
    }

    .sidebar-content {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
    }

    .sidebar-toggle {
      position: fixed;
      left: 280px;
      top: 100px;
      z-index: 101;
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: 0 6px 6px 0;
      padding: 12px 8px;
      cursor: pointer;
      font-size: 1.2rem;
      transition: left 0.3s ease;
      box-shadow: 2px 2px 8px rgba(0, 0, 0, 0.3);
    }

    .sidebar-toggle:hover {
      background: #1d4ed8;
    }

    .sidebar.collapsed ~ .sidebar-toggle {
      left: 0;
    }

    /* Project Group */
    .project-group {
      margin-bottom: 16px;
    }

    .project-header {
      padding: 10px 12px;
      background: var(--bg-color);
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
      color: var(--text-primary);
      transition: background 0.2s;
    }

    .project-header:hover {
      background: var(--border-color);
    }

    .project-header .icon {
      font-size: 0.9rem;
      transition: transform 0.2s;
    }

    .project-group.collapsed .project-header .icon {
      transform: rotate(-90deg);
    }

    .session-list {
      padding-left: 8px;
      margin-top: 4px;
      max-height: 500px;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }

    .project-group.collapsed .session-list {
      max-height: 0;
    }

    .session-item {
      padding: 8px 12px;
      margin: 2px 0;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      color: var(--text-secondary);
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .session-item:hover {
      background: var(--bg-color);
      color: var(--text-primary);
    }

    .session-item.active {
      background: var(--primary-color);
      color: white;
    }

    .session-item .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .session-item .status-dot.planning {
      background: #f59e0b;
    }

    .session-item .status-dot.building {
      background: #3b82f6;
    }

    .session-item .status-dot.completed {
      background: #10b981;
    }

    .session-item .status-dot.error {
      background: #ef4444;
    }

    .new-session-btn {
      margin: 10px;
      padding: 12px;
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.2s;
    }

    .new-session-btn:hover {
      background: #1d4ed8;
    }

    /* Main Chat Area */
    .main-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: var(--bg-color);
      position: relative;
      transition: margin-left 0.3s ease;
    }

    .sidebar.collapsed ~ .main-area {
      margin-left: -280px;
    }

    .main-header {
      padding: 20px 30px;
      border-bottom: 1px solid var(--border-color);
      background: var(--surface-color);
    }

    .main-header h2 {
      margin: 0;
      color: var(--accent-color);
      font-size: 1.3rem;
    }

    .main-header .subtitle {
      margin-top: 5px;
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    .chat-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 30px;
      background: var(--bg-color);
    }

    .chat-message {
      margin-bottom: 24px;
      display: flex;
      gap: 12px;
    }

    .chat-message.user {
      flex-direction: row-reverse;
    }

    .chat-message-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--primary-color);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 0.9rem;
      flex-shrink: 0;
    }

    .chat-message.assistant .chat-message-avatar {
      background: var(--accent-color);
    }

    .chat-message-content {
      max-width: 70%;
      padding: 12px 16px;
      border-radius: 12px;
      background: var(--surface-color);
      border: 1px solid var(--border-color);
      line-height: 1.6;
    }

    .chat-message.user .chat-message-content {
      background: var(--primary-color);
      color: white;
      border: none;
    }

    .chat-message-time {
      font-size: 0.75rem;
      color: var(--text-secondary);
      margin-top: 4px;
    }

    .chat-input-container {
      border-top: 1px solid var(--border-color);
      padding: 20px 30px;
      background: var(--surface-color);
    }

    .chat-input-wrapper {
      display: flex;
      gap: 12px;
      align-items: flex-end;
      background: var(--bg-color);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 8px 12px;
      transition: border-color 0.2s;
    }

    .chat-input-wrapper:focus-within {
      border-color: var(--primary-color);
    }

    .chat-input {
      flex: 1;
      background: transparent;
      color: var(--text-primary);
      border: none;
      font-size: 1rem;
      resize: none;
      min-height: 24px;
      max-height: 120px;
      outline: none;
      font-family: inherit;
    }

    .chat-send-btn {
      padding: 8px 20px;
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
      font-size: 0.9rem;
    }

    .chat-send-btn:hover {
      background: #1d4ed8;
    }

    .chat-send-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Empty State */
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: var(--text-secondary);
      text-align: center;
      padding: 40px;
    }

    .empty-state-icon {
      font-size: 4rem;
      margin-bottom: 20px;
    }

    .empty-state h3 {
      color: var(--text-primary);
      margin-bottom: 10px;
    }

    /* New Session Modal */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal.hidden {
      display: none;
    }

    .modal-content {
      background: var(--surface-color);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 30px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    .modal-header h2 {
      margin: 0;
      color: var(--accent-color);
    }

    .close-button {
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
      transition: all 0.2s;
    }

    .close-button:hover {
      background: var(--border-color);
      color: var(--text-primary);
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .form-group select {
      width: 100%;
      padding: 10px;
      background: var(--bg-color);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      font-size: 1rem;
    }

    .document-list {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      background: var(--bg-color);
    }

    .document-item {
      padding: 12px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      gap: 10px;
      transition: background 0.2s;
    }

    .document-item:last-child {
      border-bottom: none;
    }

    .document-item:hover {
      background: var(--surface-color);
    }

    .document-item input[type="checkbox"] {
      width: 18px;
      height: 18px;
    }

    .document-title {
      flex: 1;
      font-weight: 500;
    }

    .document-type {
      padding: 2px 8px;
      background: var(--primary-color);
      color: white;
      border-radius: 4px;
      font-size: 0.75rem;
    }

    .action-buttons {
      display: flex;
      gap: 12px;
      margin-top: 24px;
    }

    .btn {
      flex: 1;
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 1rem;
      transition: all 0.2s;
    }

    .btn-primary {
      background: var(--primary-color);
      color: white;
    }

    .btn-primary:hover {
      background: #1d4ed8;
    }

    .btn-secondary {
      background: var(--border-color);
      color: var(--text-primary);
    }

    .btn-secondary:hover {
      background: var(--surface-color);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    @media (max-width: 768px) {
      .sidebar {
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        z-index: 200;
      }

      .sidebar:not(.collapsed) {
        box-shadow: 4px 0 12px rgba(0, 0, 0, 0.3);
      }

      .main-area {
        margin-left: 0 !important;
      }
    }
  </style>
</head>
<body>
  <!-- Navigation -->
  <nav class="page-header-nav">
    <div class="nav-left">
      <a href="/" class="nav-link home">ğŸ  ãƒ›ãƒ¼ãƒ </a>
      <h2 style="margin: 0; color: var(--text-primary);">ğŸ¤– Cursor Agent</h2>
    </div>
    <button class="hamburger-menu" id="hamburger-menu" aria-label="ãƒ¡ãƒ‹ãƒ¥ãƒ¼">
      <span></span>
      <span></span>
      <span></span>
    </button>
    <div class="nav-links" id="nav-links">
      <a href="/webcam.html" class="nav-link">ğŸ¥ ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°ä½œæˆ</a>
      <a href="/cursor-agent.html" class="nav-link">ğŸ¤– ã‚³ãƒ¼ãƒ‰ç”Ÿæˆ</a>
      <a href="/documents.html" class="nav-link">ğŸ“‚ ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°å±¥æ­´</a>
      <a href="/cursor-builds.html" class="nav-link">ğŸ“œ ã‚³ãƒ¼ãƒ‰ç”Ÿæˆå±¥æ­´</a>
      <a href="/projects.html" class="nav-link">ğŸ“ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç®¡ç†</a>
    </div>
  </nav>

  <script>
    // ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ãƒˆã‚°ãƒ«
    const hamburger = document.getElementById('hamburger-menu');
    const navLinks = document.getElementById('nav-links');
    
    hamburger.addEventListener('click', () => {
      hamburger.classList.toggle('active');
      navLinks.classList.toggle('active');
    });

    document.addEventListener('click', (e) => {
      if (!hamburger.contains(e.target) && !navLinks.contains(e.target)) {
        hamburger.classList.remove('active');
        navLinks.classList.remove('active');
      }
    });
  </script>

  <!-- Main Layout -->
  <div class="app-layout">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <h3>ğŸ“ ã‚»ãƒƒã‚·ãƒ§ãƒ³å±¥æ­´</h3>
      </div>
      <button class="new-session-btn" id="new-session-btn">â• æ–°è¦ã‚»ãƒƒã‚·ãƒ§ãƒ³</button>
      <div class="sidebar-content" id="sidebar-content">
        <!-- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚°ãƒ«ãƒ¼ãƒ—ãŒã“ã“ã«å‹•çš„ã«è¿½åŠ ã•ã‚Œã‚‹ -->
      </div>
    </aside>

    <!-- Sidebar Toggle Button -->
    <button class="sidebar-toggle" id="sidebar-toggle" aria-label="ã‚µã‚¤ãƒ‰ãƒãƒ¼åˆ‡ã‚Šæ›¿ãˆ">
      â—€
    </button>

    <!-- Main Area -->
    <main class="main-area">
      <div class="main-header">
        <h2 id="session-title">æ–°è¦ã‚»ãƒƒã‚·ãƒ§ãƒ³</h2>
        <div class="subtitle" id="session-subtitle">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¨ä»•æ§˜æ›¸ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
      </div>

      <div class="chat-container">
        <div class="chat-messages" id="chat-messages">
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ’¬</div>
            <h3>Cursor Agent ã¸ã‚ˆã†ã“ã</h3>
            <p>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠã—ã¦æ–°ã—ã„ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é–‹å§‹ã™ã‚‹ã‹ã€<br>å·¦ã®ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‹ã‚‰éå»ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</p>
          </div>
        </div>

        <div class="chat-input-container">
          <div class="chat-input-wrapper">
            <textarea 
              id="chat-input" 
              class="chat-input" 
              placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›... (Shift+Enterã§æ”¹è¡Œ)"
              rows="1"
              disabled
            ></textarea>
            <button id="chat-send-btn" class="chat-send-btn" disabled>é€ä¿¡</button>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- New Session Modal -->
  <div id="new-session-modal" class="modal hidden">
    <div class="modal-content">
      <div class="modal-header">
        <h2>ğŸ†• æ–°è¦ã‚»ãƒƒã‚·ãƒ§ãƒ³</h2>
        <button class="close-button" id="close-modal">&times;</button>
      </div>

      <div class="form-group">
        <label>ğŸ“ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé¸æŠï¼ˆå¿…é ˆï¼‰</label>
        <select id="project-select">
          <option value="">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„</option>
        </select>
      </div>

      <div class="form-group">
        <label>ğŸ“„ ä»•æ§˜æ›¸ã‚’é¸æŠ</label>
        <div id="document-list" class="document-list">
          <div style="padding: 20px; text-align: center; color: var(--text-secondary);">
            ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„
          </div>
        </div>
      </div>

      <div class="action-buttons">
        <button class="btn btn-secondary" id="cancel-btn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn btn-primary" id="create-session-btn" disabled>ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆ</button>
      </div>
    </div>
  </div>

  <script>
    const API_BASE_URL = 'http://localhost:3000';

    // State
    let projects = [];
    let documents = [];
    let sessions = [];
    let currentSessionId = null;
    let currentProjectId = null;

    // DOM Elements
    const sidebar = document.getElementById('sidebar');
    const sidebarToggle = document.getElementById('sidebar-toggle');
    const sidebarContent = document.getElementById('sidebar-content');
    const newSessionBtn = document.getElementById('new-session-btn');
    const newSessionModal = document.getElementById('new-session-modal');
    const closeModal = document.getElementById('close-modal');
    const projectSelect = document.getElementById('project-select');
    const documentList = document.getElementById('document-list');
    const createSessionBtn = document.getElementById('create-session-btn');
    const cancelBtn = document.getElementById('cancel-btn');
    const chatMessages = document.getElementById('chat-messages');
    const chatInput = document.getElementById('chat-input');
    const chatSendBtn = document.getElementById('chat-send-btn');
    const sessionTitle = document.getElementById('session-title');
    const sessionSubtitle = document.getElementById('session-subtitle');

    // Initialize
    async function init() {
      try {
        await loadProjects();
        await loadSessions();
        setupEventListeners();
      } catch (error) {
        console.error('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
        alert('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }

    // Load projects
    async function loadProjects() {
      const res = await fetch(`${API_BASE_URL}/api/projects`);
      if (!res.ok) throw new Error('Failed to load projects');
      const data = await res.json();
      projects = data.projects;

      // Populate project select
      projectSelect.innerHTML = '<option value="">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
      projects.forEach(project => {
        const option = document.createElement('option');
        option.value = project.id;
        option.textContent = project.name;
        projectSelect.appendChild(option);
      });
    }

    // Load sessions
    async function loadSessions() {
      const res = await fetch(`${API_BASE_URL}/api/cursor-agent/sessions`);
      if (!res.ok) throw new Error('Failed to load sessions');
      const data = await res.json();
      sessions = data.sessions;

      renderSidebar();
    }

    // Render sidebar
    function renderSidebar() {
      // Group sessions by project
      const projectGroups = {};
      sessions.forEach(session => {
        const projectId = session.projectId;
        if (!projectGroups[projectId]) {
          projectGroups[projectId] = {
            project: session.project,
            sessions: []
          };
        }
        projectGroups[projectId].sessions.push(session);
      });

      // Render groups
      sidebarContent.innerHTML = '';
      Object.values(projectGroups).forEach(group => {
        if (!group.project) return;

        const projectGroupEl = document.createElement('div');
        projectGroupEl.className = 'project-group';

        const projectHeaderEl = document.createElement('div');
        projectHeaderEl.className = 'project-header';
        projectHeaderEl.innerHTML = `
          <span class="icon">â–¼</span>
          <span>${group.project.name}</span>
        `;
        projectHeaderEl.addEventListener('click', () => {
          projectGroupEl.classList.toggle('collapsed');
        });

        const sessionListEl = document.createElement('div');
        sessionListEl.className = 'session-list';

        group.sessions.forEach(session => {
          const sessionItemEl = document.createElement('div');
          sessionItemEl.className = 'session-item';
          if (session.id === currentSessionId) {
            sessionItemEl.classList.add('active');
          }

          const createdAt = new Date(session.createdAt);
          const dateStr = createdAt.toLocaleDateString('ja-JP', { month: 'short', day: 'numeric' });

          sessionItemEl.innerHTML = `
            <span class="status-dot ${session.status}"></span>
            <span style="flex: 1; overflow: hidden; text-overflow: ellipsis;">${dateStr}</span>
          `;

          sessionItemEl.addEventListener('click', () => loadSession(session.id));

          sessionListEl.appendChild(sessionItemEl);
        });

        projectGroupEl.appendChild(projectHeaderEl);
        projectGroupEl.appendChild(sessionListEl);
        sidebarContent.appendChild(projectGroupEl);
      });
    }

    // Load session
    async function loadSession(sessionId) {
      try {
        const res = await fetch(`${API_BASE_URL}/api/cursor-agent/sessions/${sessionId}`);
        if (!res.ok) throw new Error('Failed to load session');
        const data = await res.json();
        const session = data.session;

        currentSessionId = sessionId;
        currentProjectId = session.projectId;

        // Update header
        sessionTitle.textContent = session.project?.name || 'ã‚»ãƒƒã‚·ãƒ§ãƒ³';
        sessionSubtitle.textContent = `ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${getStatusText(session.status)}`;

        // Render chat history
        renderChatHistory(session);

        // Enable chat input
        chatInput.disabled = false;
        chatSendBtn.disabled = false;

        // Update sidebar
        renderSidebar();
      } catch (error) {
        console.error('ã‚»ãƒƒã‚·ãƒ§ãƒ³èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        alert('ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }

    // Render chat history
    function renderChatHistory(session) {
      chatMessages.innerHTML = '';

      // Add initial message
      addChatMessage('assistant', `ã“ã‚“ã«ã¡ã¯ï¼${session.project?.name}ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚³ãƒ¼ãƒ‰ç”Ÿæˆã‚’ã‚µãƒãƒ¼ãƒˆã—ã¾ã™ã€‚`);

      // Add plan if exists
      if (session.plan) {
        const planMessage = `ãƒ—ãƒ©ãƒ³ã‚’ä½œæˆã—ã¾ã—ãŸ:\n\n${session.plan.summary || ''}`;
        addChatMessage('assistant', planMessage);
      }

      // Add build if exists
      if (session.build) {
        const buildMessage = `âœ… ãƒ“ãƒ«ãƒ‰ãŒå®Œäº†ã—ã¾ã—ãŸï¼`;
        addChatMessage('assistant', buildMessage);
      }

      // Add chat history if exists
      if (session.chatHistory && Array.isArray(session.chatHistory)) {
        session.chatHistory.forEach(msg => {
          addChatMessage(msg.role, msg.content);
        });
      }
    }

    // Add chat message
    function addChatMessage(role, content) {
      const messageEl = document.createElement('div');
      messageEl.className = `chat-message ${role}`;

      const avatar = role === 'user' ? 'U' : 'ğŸ¤–';
      const time = new Date().toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });

      messageEl.innerHTML = `
        <div class="chat-message-avatar">${avatar}</div>
        <div class="chat-message-content">
          <div>${content.replace(/\n/g, '<br>')}</div>
          <div class="chat-message-time">${time}</div>
        </div>
      `;

      chatMessages.appendChild(messageEl);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Get status text
    function getStatusText(status) {
      const statusMap = {
        'planning': 'è¨ˆç”»ä¸­',
        'building': 'ãƒ“ãƒ«ãƒ‰ä¸­',
        'completed': 'å®Œäº†',
        'error': 'ã‚¨ãƒ©ãƒ¼'
      };
      return statusMap[status] || status;
    }

    // Send chat message
    async function sendChatMessage() {
      const message = chatInput.value.trim();
      if (!message || !currentSessionId) return;

      try {
        addChatMessage('user', message);
        chatInput.value = '';
        chatSendBtn.disabled = true;

        const res = await fetch(`${API_BASE_URL}/api/cursor-agent/sessions/${currentSessionId}/chat`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message })
        });

        if (!res.ok) throw new Error('Failed to send message');

        const data = await res.json();
        addChatMessage('assistant', data.response);

      } catch (error) {
        console.error('ãƒãƒ£ãƒƒãƒˆé€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
        addChatMessage('assistant', 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
      } finally {
        chatSendBtn.disabled = false;
        chatInput.focus();
      }
    }

    // Setup event listeners
    function setupEventListeners() {
      // Sidebar toggle
      sidebarToggle.addEventListener('click', () => {
        sidebar.classList.toggle('collapsed');
        sidebarToggle.textContent = sidebar.classList.contains('collapsed') ? 'â–¶' : 'â—€';
      });

      // New session
      newSessionBtn.addEventListener('click', () => {
        newSessionModal.classList.remove('hidden');
      });

      closeModal.addEventListener('click', () => {
        newSessionModal.classList.add('hidden');
      });

      cancelBtn.addEventListener('click', () => {
        newSessionModal.classList.add('hidden');
      });

      // Project select
      projectSelect.addEventListener('change', async (e) => {
        const projectId = e.target.value;
        if (!projectId) {
          documentList.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-secondary);">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„</div>';
          createSessionBtn.disabled = true;
          return;
        }

        try {
          const res = await fetch(`${API_BASE_URL}/api/processing/documents?projectId=${projectId}`);
          if (!res.ok) throw new Error('Failed to load documents');
          const data = await res.json();
          documents = data.documents;

          renderDocuments();
          createSessionBtn.disabled = false;
        } catch (error) {
          console.error('ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
          documentList.innerHTML = '<div style="padding: 20px; text-align: center; color: red;">èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼</div>';
        }
      });

      // Create session
      createSessionBtn.addEventListener('click', async () => {
        const projectId = projectSelect.value;
        if (!projectId) return;

        const selectedDocs = Array.from(documentList.querySelectorAll('input[type="checkbox"]:checked'))
          .map(cb => cb.value);

        try {
          createSessionBtn.disabled = true;
          createSessionBtn.textContent = 'ä½œæˆä¸­...';

          const res = await fetch(`${API_BASE_URL}/api/cursor-agent/sessions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              projectId,
              documentIds: selectedDocs
            })
          });

          if (!res.ok) throw new Error('Failed to create session');

          const data = await res.json();
          currentSessionId = data.sessionId;

          // Close modal
          newSessionModal.classList.add('hidden');

          // Reload sessions and load new session
          await loadSessions();
          await loadSession(currentSessionId);

        } catch (error) {
          console.error('ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆã‚¨ãƒ©ãƒ¼:', error);
          alert('ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
        } finally {
          createSessionBtn.disabled = false;
          createSessionBtn.textContent = 'ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆ';
        }
      });

      // Chat send
      chatSendBtn.addEventListener('click', sendChatMessage);

      chatInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendChatMessage();
        }
      });

      // Auto-resize textarea
      chatInput.addEventListener('input', () => {
        chatInput.style.height = 'auto';
        chatInput.style.height = chatInput.scrollHeight + 'px';
      });
    }

    // Render documents
    function renderDocuments() {
      if (documents.length === 0) {
        documentList.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-secondary);">ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</div>';
        return;
      }

      documentList.innerHTML = '';
      documents.forEach(doc => {
        const item = document.createElement('div');
        item.className = 'document-item';
        item.innerHTML = `
          <input type="checkbox" value="${doc.id}">
          <span class="document-title">${doc.title}</span>
          <span class="document-type">${doc.type}</span>
        `;
        documentList.appendChild(item);
      });
    }

    // Start
    init();
  </script>
</body>
</html>

