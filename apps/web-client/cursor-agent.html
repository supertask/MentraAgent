<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cursor Agent - Realworld Agent</title>
  <link rel="stylesheet" href="/styles.css">
  <style>
    :root {
      --header-h: 60px;
    }

    body {
      margin: 0;
    }

    /* Layout with Sidebar */
    .app-layout {
      display: flex;
      min-height: calc(100dvh - var(--header-h));
      position: relative;
    }

    /* Sidebar Styles */
    .sidebar {
      width: 280px;
      background: var(--surface-color);
      border-right: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      transition: transform 0.3s ease;
      overflow: hidden;
      position: relative;
      z-index: 100;
    }

    .sidebar.collapsed {
      transform: translateX(-280px);
    }

    .sidebar-header {
      padding: 20px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .sidebar-header h3 {
      color: var(--accent-color);
      font-size: 1.1rem;
      margin: 0;
    }

    .sidebar-content {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
    }

    .sidebar-toggle {
      position: fixed;
      left: 280px;
      top: 100px;
      z-index: 101;
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: 0 6px 6px 0;
      padding: 12px 8px;
      cursor: pointer;
      font-size: 1.2rem;
      transition: left 0.3s ease;
      box-shadow: 2px 2px 8px rgba(0, 0, 0, 0.3);
    }

    .sidebar-toggle:hover {
      background: #1d4ed8;
    }

    .sidebar.collapsed ~ .sidebar-toggle {
      left: 0;
    }

    /* Project Group */
    .project-group {
      margin-bottom: 16px;
    }

    .project-header {
      padding: 10px 12px;
      background: var(--bg-color);
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
      color: var(--text-primary);
      transition: background 0.2s;
    }

    .project-header:hover {
      background: var(--border-color);
    }

    .project-header .icon {
      font-size: 0.9rem;
      transition: transform 0.2s;
    }

    .project-group.collapsed .project-header .icon {
      transform: rotate(-90deg);
    }

    .session-list {
      padding-left: 8px;
      margin-top: 4px;
      max-height: 500px;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }

    .project-group.collapsed .session-list {
      max-height: 0;
    }

    .session-item {
      padding: 8px 12px;
      margin: 2px 0;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      color: var(--text-secondary);
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .session-item:hover {
      background: var(--bg-color);
      color: var(--text-primary);
    }

    .session-item.active {
      background: var(--primary-color);
      color: white;
    }

    .session-item-content {
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 1;
      overflow: hidden;
      min-width: 0;
    }

    .session-item-actions {
      position: relative;
      margin-left: auto;
      opacity: 0;
      transition: opacity 0.2s;
      flex-shrink: 0;
    }

    .session-item:hover .session-item-actions {
      opacity: 1;
    }

    .session-menu-btn {
      background: none;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      padding: 4px 8px;
      font-size: 1.2rem;
      transition: all 0.2s;
      border-radius: 4px;
      line-height: 1;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .session-menu-btn:hover {
      background: var(--border-color);
      color: var(--text-primary);
    }

    .session-item.active .session-menu-btn {
      color: white;
    }

    .session-item.active .session-menu-btn:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .session-menu {
      position: fixed;
      background: var(--surface-color);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      min-width: 150px;
      z-index: 10000;
      display: none;
      white-space: nowrap;
    }

    .session-menu.show {
      display: block;
    }

    .session-menu-item {
      padding: 10px 16px;
      cursor: pointer;
      transition: background 0.2s;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 20px;
      color: var(--text-primary);
      font-size: 0.9rem;
      min-width: 160px;
    }

    .session-menu-item:first-child {
      border-radius: 8px 8px 0 0;
    }

    .session-menu-item:last-child {
      border-radius: 0 0 8px 8px;
    }

    .session-menu-item:only-child {
      border-radius: 8px;
    }

    .session-menu-item:hover {
      background: var(--border-color);
    }

    .session-menu-item.danger {
      color: #ef4444;
    }

    .session-menu-item.danger:hover {
      background: rgba(239, 68, 68, 0.1);
    }

    .session-item .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .session-item .status-dot.planning {
      background: #f59e0b;
    }

    .session-item .status-dot.building {
      background: #3b82f6;
    }

    .session-item .status-dot.completed {
      background: #10b981;
    }

    .session-item .status-dot.error {
      background: #ef4444;
    }

    .new-session-btn {
      margin: 10px;
      padding: 12px;
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.2s;
    }

    .new-session-btn:hover {
      background: #1d4ed8;
    }

    /* Main Chat Area */
    .main-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: var(--bg-color);
      position: relative;
      transition: margin-left 0.3s ease;
      min-height: 0;
    }

    .sidebar.collapsed ~ .main-area {
      margin-left: -280px;
    }

    .main-header {
      padding: 20px 30px;
      border-bottom: 1px solid var(--border-color);
      background: var(--surface-color);
      flex-shrink: 0;
    }

    .main-header h2 {
      margin: 0;
      color: var(--accent-color);
      font-size: 1.3rem;
    }

    .main-header .subtitle {
      margin-top: 5px;
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    .chat-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      min-height: 0;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 30px;
      padding-bottom: 120px;
      background: var(--bg-color);
    }

    .chat-message {
      margin-bottom: 24px;
      display: flex;
      gap: 12px;
    }

    .chat-message.user {
      flex-direction: row-reverse;
    }

    .chat-message-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--primary-color);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 0.9rem;
      flex-shrink: 0;
    }

    .chat-message.assistant .chat-message-avatar {
      background: var(--accent-color);
    }

    .chat-message-content {
      max-width: 70%;
      padding: 12px 16px;
      border-radius: 12px;
      background: var(--surface-color);
      border: 1px solid var(--border-color);
      line-height: 1.6;
    }

    .chat-message.user .chat-message-content {
      background: var(--primary-color);
      color: white;
      border: none;
    }

    .chat-message-time {
      font-size: 0.75rem;
      color: var(--text-secondary);
      margin-top: 4px;
    }

    /* Typing Indicator */
    .typing-indicator {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 8px 0;
    }

    .typing-indicator span {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--text-secondary);
      animation: typing 1.4s infinite;
      opacity: 0.4;
    }

    .typing-indicator span:nth-child(1) {
      animation-delay: 0s;
    }

    .typing-indicator span:nth-child(2) {
      animation-delay: 0.2s;
    }

    .typing-indicator span:nth-child(3) {
      animation-delay: 0.4s;
    }

    @keyframes typing {
      0%, 60%, 100% {
        opacity: 0.4;
        transform: translateY(0);
      }
      30% {
        opacity: 1;
        transform: translateY(-10px);
      }
    }

    /* Action Buttons in Chat */
    .chat-action-buttons {
      margin: 20px 0;
      padding: 20px;
      background: var(--surface-color);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .chat-action-btn {
      flex: 1;
      min-width: 200px;
      padding: 14px 24px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 1rem;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .chat-action-btn.primary {
      background: var(--primary-color);
      color: white;
    }

    .chat-action-btn.primary:hover {
      background: #1d4ed8;
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(37, 99, 235, 0.3);
    }

    .chat-action-btn.success {
      background: #10b981;
      color: white;
    }

    .chat-action-btn.success:hover {
      background: #059669;
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(16, 185, 129, 0.3);
    }

    .chat-action-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }

    .chat-input-container {
      border-top: 1px solid var(--border-color);
      padding: 16px 30px;
      background: var(--surface-color);
      position: fixed;
      bottom: 0;
      left: 280px;
      right: 0;
      z-index: 200;
      transition: left 0.3s ease;
    }

    .sidebar.collapsed ~ .main-area .chat-input-container {
      left: 0;
    }

    .chat-input-wrapper {
      display: flex;
      gap: 12px;
      align-items: flex-end;
      background: var(--bg-color);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 8px 12px;
      transition: border-color 0.2s;
    }

    .chat-input-wrapper:focus-within {
      border-color: var(--primary-color);
    }

    .chat-input {
      flex: 1;
      background: transparent;
      color: var(--text-primary);
      border: none;
      font-size: 1rem;
      resize: none;
      min-height: 24px;
      max-height: 120px;
      outline: none;
      font-family: inherit;
    }

    .chat-send-btn {
      padding: 8px 20px;
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
      font-size: 0.9rem;
    }

    .chat-send-btn:hover {
      background: #1d4ed8;
    }

    .chat-send-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Empty State */
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: var(--text-secondary);
      text-align: center;
      padding: 40px;
    }

    .empty-state-icon {
      font-size: 4rem;
      margin-bottom: 20px;
    }

    .empty-state h3 {
      color: var(--text-primary);
      margin-bottom: 10px;
    }

    /* New Session Modal */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal.hidden {
      display: none;
    }

    .modal-content {
      background: var(--surface-color);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 30px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    .modal-header h2 {
      margin: 0;
      color: var(--accent-color);
    }

    .close-button {
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
      transition: all 0.2s;
    }

    .close-button:hover {
      background: var(--border-color);
      color: var(--text-primary);
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .form-group select {
      width: 100%;
      padding: 10px;
      background: var(--bg-color);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      font-size: 1rem;
    }

    .document-list {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      background: var(--bg-color);
    }

    .document-item {
      padding: 12px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      gap: 10px;
      transition: background 0.2s;
    }

    .document-item:last-child {
      border-bottom: none;
    }

    .document-item:hover {
      background: var(--surface-color);
    }

    .document-item input[type="checkbox"] {
      width: 18px;
      height: 18px;
    }

    .document-title {
      flex: 1;
      font-weight: 500;
    }

    .document-type {
      padding: 2px 8px;
      background: var(--primary-color);
      color: white;
      border-radius: 4px;
      font-size: 0.75rem;
    }

    .action-buttons {
      display: flex;
      gap: 12px;
      margin-top: 24px;
    }

    .btn {
      flex: 1;
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 1rem;
      transition: all 0.2s;
    }

    .btn-primary {
      background: var(--primary-color);
      color: white;
    }

    .btn-primary:hover {
      background: #1d4ed8;
    }

    .btn-secondary {
      background: var(--border-color);
      color: var(--text-primary);
    }

    .btn-secondary:hover {
      background: var(--surface-color);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    @media (max-width: 768px) {
      .sidebar {
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        z-index: 200;
      }

      .sidebar:not(.collapsed) {
        box-shadow: 4px 0 12px rgba(0, 0, 0, 0.3);
      }

      .main-area {
        margin-left: 0 !important;
      }

      .chat-input-container {
        left: 0 !important;
        padding: 12px 16px;
      }
    }
  </style>
</head>
<body>
  <!-- Navigation -->
  <nav class="page-header-nav">
    <div class="nav-left">
      <a href="/" class="nav-link home">🏠 ホーム</a>
      <h2 style="margin: 0; color: var(--text-primary);">🤖 Cursor Agent</h2>
    </div>
    <button class="hamburger-menu" id="hamburger-menu" aria-label="メニュー">
      <span></span>
      <span></span>
      <span></span>
    </button>
    <div class="nav-links" id="nav-links">
      <a href="/webcam.html" class="nav-link">🎥 ミーティング作成</a>
      <a href="/cursor-agent.html" class="nav-link">🤖 コード生成</a>
      <a href="/documents.html" class="nav-link">📂 ミーティング履歴</a>
      <a href="/cursor-builds.html" class="nav-link">📜 コード生成履歴</a>
      <a href="/projects.html" class="nav-link">📁 プロジェクト管理</a>
    </div>
  </nav>

  <script>
    // ハンバーガーメニューのトグル
    const hamburger = document.getElementById('hamburger-menu');
    const navLinks = document.getElementById('nav-links');
    
    hamburger.addEventListener('click', () => {
      hamburger.classList.toggle('active');
      navLinks.classList.toggle('active');
    });

    document.addEventListener('click', (e) => {
      if (!hamburger.contains(e.target) && !navLinks.contains(e.target)) {
        hamburger.classList.remove('active');
        navLinks.classList.remove('active');
      }
    });
  </script>

  <!-- Main Layout -->
  <div class="app-layout">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <h3>📁 セッション履歴</h3>
      </div>
      <button class="new-session-btn" id="new-session-btn">➕ 新規セッション</button>
      <div class="sidebar-content" id="sidebar-content">
        <!-- プロジェクトグループがここに動的に追加される -->
      </div>
    </aside>

    <!-- Sidebar Toggle Button -->
    <button class="sidebar-toggle" id="sidebar-toggle" aria-label="サイドバー切り替え">
      ◀
    </button>

    <!-- Main Area -->
    <main class="main-area">
      <div class="main-header">
        <h2 id="session-title">新規セッション</h2>
        <div class="subtitle" id="session-subtitle">プロジェクトと仕様書を選択してください</div>
      </div>

      <div class="chat-container">
        <div class="chat-messages" id="chat-messages">
          <div class="empty-state">
            <div class="empty-state-icon">💬</div>
            <h3>Cursor Agent へようこそ</h3>
            <p>プロジェクトを選択して新しいセッションを開始するか、<br>左のサイドバーから過去のセッションを選択してください。</p>
          </div>
        </div>

        <div class="chat-input-container">
          <div class="chat-input-wrapper">
            <textarea 
              id="chat-input" 
              class="chat-input" 
              placeholder="メッセージを入力..."
              rows="1"
              disabled
            ></textarea>
            <button id="chat-send-btn" class="chat-send-btn" disabled>送信</button>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- New Session Modal -->
  <div id="new-session-modal" class="modal hidden">
    <div class="modal-content">
      <div class="modal-header">
        <h2>🆕 新規セッション</h2>
        <button class="close-button" id="close-modal">&times;</button>
      </div>

      <div class="form-group">
        <label>📁 プロジェクト選択（必須）</label>
        <select id="project-select">
          <option value="">プロジェクトを選択してください</option>
        </select>
      </div>

      <div class="form-group">
        <label>📄 仕様書を選択</label>
        <div id="document-list" class="document-list">
          <div style="padding: 20px; text-align: center; color: var(--text-secondary);">
            プロジェクトを選択してください
          </div>
        </div>
      </div>

      <div class="action-buttons">
        <button class="btn btn-secondary" id="cancel-btn">キャンセル</button>
        <button class="btn btn-primary" id="create-session-btn" disabled>セッション作成</button>
      </div>
    </div>
  </div>

  <script>
    const API_BASE_URL = 'http://localhost:3000';

    // State
    let projects = [];
    let documents = [];
    let sessions = [];
    let currentSessionId = null;
    let currentProjectId = null;

    // DOM Elements
    const sidebar = document.getElementById('sidebar');
    const sidebarToggle = document.getElementById('sidebar-toggle');
    const sidebarContent = document.getElementById('sidebar-content');
    const newSessionBtn = document.getElementById('new-session-btn');
    const newSessionModal = document.getElementById('new-session-modal');
    const closeModal = document.getElementById('close-modal');
    const projectSelect = document.getElementById('project-select');
    const documentList = document.getElementById('document-list');
    const createSessionBtn = document.getElementById('create-session-btn');
    const cancelBtn = document.getElementById('cancel-btn');
    const chatMessages = document.getElementById('chat-messages');
    const chatInput = document.getElementById('chat-input');
    const chatSendBtn = document.getElementById('chat-send-btn');
    const sessionTitle = document.getElementById('session-title');
    const sessionSubtitle = document.getElementById('session-subtitle');

    // Initialize
    async function init() {
      try {
        await loadProjects();
        await loadSessions();
        setupEventListeners();
        setupGlobalEventListeners();
      } catch (error) {
        console.error('初期化エラー:', error);
        alert('データの読み込みに失敗しました');
      }
    }

    // Setup global event listeners
    function setupGlobalEventListeners() {
      // メニュー外をクリックしたときにメニューを閉じる
      document.addEventListener('click', (e) => {
        if (!e.target.closest('.session-item-actions') && !e.target.closest('.session-menu')) {
          document.querySelectorAll('.session-menu.show').forEach(menu => {
            menu.classList.remove('show');
          });
        }
      });
    }

    // Delete session
    async function deleteSession(sessionId) {
      try {
        const res = await fetch(`${API_BASE_URL}/api/cursor-agent/sessions/${sessionId}`, {
          method: 'DELETE'
        });

        if (!res.ok) throw new Error('Failed to delete session');

        // セッションリストから削除
        sessions = sessions.filter(s => s.id !== sessionId);

        // 現在のセッションが削除された場合
        if (currentSessionId === sessionId) {
          currentSessionId = null;
          chatMessages.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">💬</div>
              <h3>セッションが削除されました</h3>
              <p>左のサイドバーから別のセッションを選択するか、<br>新しいセッションを作成してください。</p>
            </div>
          `;
          sessionTitle.textContent = '新規セッション';
          sessionSubtitle.textContent = 'プロジェクトと仕様書を選択してください';
          chatInput.disabled = true;
          chatSendBtn.disabled = true;
        }

        // サイドバーを更新
        renderSidebar();

        console.log('セッションを削除しました:', sessionId);
      } catch (error) {
        console.error('セッション削除エラー:', error);
        alert('セッションの削除に失敗しました');
      }
    }

    // Load projects
    async function loadProjects() {
      const res = await fetch(`${API_BASE_URL}/api/projects`);
      if (!res.ok) throw new Error('Failed to load projects');
      const data = await res.json();
      projects = data.projects;

      // Populate project select
      projectSelect.innerHTML = '<option value="">プロジェクトを選択してください</option>';
      projects.forEach(project => {
        const option = document.createElement('option');
        option.value = project.id;
        option.textContent = project.name;
        projectSelect.appendChild(option);
      });
    }

    // Load sessions
    async function loadSessions() {
      const res = await fetch(`${API_BASE_URL}/api/cursor-agent/sessions`);
      if (!res.ok) throw new Error('Failed to load sessions');
      const data = await res.json();
      sessions = data.sessions;

      renderSidebar();
    }

    // Render sidebar
    function renderSidebar() {
      // Group sessions by project
      const projectGroups = {};
      sessions.forEach(session => {
        const projectId = session.projectId;
        if (!projectGroups[projectId]) {
          projectGroups[projectId] = {
            project: session.project,
            sessions: []
          };
        }
        projectGroups[projectId].sessions.push(session);
      });

      // Render groups
      sidebarContent.innerHTML = '';
      Object.values(projectGroups).forEach(group => {
        if (!group.project) return;

        const projectGroupEl = document.createElement('div');
        projectGroupEl.className = 'project-group';

        const projectHeaderEl = document.createElement('div');
        projectHeaderEl.className = 'project-header';
        projectHeaderEl.innerHTML = `
          <span class="icon">▼</span>
          <span>${group.project.name}</span>
        `;
        projectHeaderEl.addEventListener('click', () => {
          projectGroupEl.classList.toggle('collapsed');
        });

        const sessionListEl = document.createElement('div');
        sessionListEl.className = 'session-list';

        group.sessions.forEach(session => {
          const sessionItemEl = document.createElement('div');
          sessionItemEl.className = 'session-item';
          if (session.id === currentSessionId) {
            sessionItemEl.classList.add('active');
          }

          const createdAt = new Date(session.createdAt);
          const dateStr = createdAt.toLocaleDateString('ja-JP', { month: 'short', day: 'numeric' });

          sessionItemEl.innerHTML = `
            <div class="session-item-content">
              <span class="status-dot ${session.status}"></span>
              <span style="flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${dateStr}</span>
            </div>
            <div class="session-item-actions">
              <button class="session-menu-btn" data-session-id="${session.id}" title="メニュー">⋮</button>
              <div class="session-menu">
                <div class="session-menu-item danger" data-action="delete">
                  <span>削除</span>
                  <span style="margin-left: auto;">🗑️</span>
                </div>
              </div>
            </div>
          `;

          // セッション選択（メニューボタン以外をクリック）
          sessionItemEl.addEventListener('click', (e) => {
            if (!e.target.closest('.session-item-actions')) {
              loadSession(session.id);
            }
          });

          // 3点メニューボタン
          const menuBtn = sessionItemEl.querySelector('.session-menu-btn');
          const menu = sessionItemEl.querySelector('.session-menu');
          
          menuBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            
            // 他の開いているメニューを閉じる
            document.querySelectorAll('.session-menu.show').forEach(m => {
              if (m !== menu) m.classList.remove('show');
            });
            
            // このメニューをトグル
            const isShowing = menu.classList.toggle('show');
            
            // メニューの位置を計算（3点マークの真下、左端揃え）
            if (isShowing) {
              const btnRect = menuBtn.getBoundingClientRect();
              menu.style.top = `${btnRect.bottom + 4}px`;
              menu.style.left = `${btnRect.left}px`;
            }
          });

          // メニュー項目のクリック
          menu.addEventListener('click', async (e) => {
            e.stopPropagation();
            const item = e.target.closest('.session-menu-item');
            if (!item) return;

            const action = item.dataset.action;
            menu.classList.remove('show');

            if (action === 'delete') {
              if (confirm(`このセッション (${dateStr}) を削除しますか？\nCursor Agentのセッションも削除されます。`)) {
                await deleteSession(session.id);
              }
            }
          });

          sessionListEl.appendChild(sessionItemEl);
        });

        projectGroupEl.appendChild(projectHeaderEl);
        projectGroupEl.appendChild(sessionListEl);
        sidebarContent.appendChild(projectGroupEl);
      });
    }

    // Load session
    async function loadSession(sessionId) {
      try {
        const res = await fetch(`${API_BASE_URL}/api/cursor-agent/sessions/${sessionId}`);
        if (!res.ok) throw new Error('Failed to load session');
        const data = await res.json();
        const session = data.session;

        currentSessionId = sessionId;
        currentProjectId = session.projectId;

        // Update header
        sessionTitle.textContent = session.project?.name || 'セッション';
        sessionSubtitle.textContent = `ステータス: ${getStatusText(session.status)}`;

        // Render chat history
        renderChatHistory(session);

        // Enable chat input only if plan exists
        if (session.plan) {
          chatInput.disabled = false;
          chatSendBtn.disabled = false;
        } else {
          chatInput.disabled = true;
          chatSendBtn.disabled = true;
        }

        // Update sidebar
        renderSidebar();
      } catch (error) {
        console.error('セッション読み込みエラー:', error);
        alert('セッションの読み込みに失敗しました');
      }
    }

    // Render chat history
    function renderChatHistory(session) {
      chatMessages.innerHTML = '';

      // Display chat history if exists
      if (session.chatHistory && Array.isArray(session.chatHistory) && session.chatHistory.length > 0) {
        // チャット履歴を表示（初期メッセージも含まれている）
        session.chatHistory.forEach(msg => {
          addChatMessage(msg.role, msg.content);
        });
      } else {
        // フォールバック: 履歴がない場合は初期メッセージを表示
        addChatMessage('assistant', `こんにちは！${session.project?.name}プロジェクトのコード生成をサポートします。`);
      }

      // Add action buttons based on session status (regardless of chat history)
      if (!session.plan) {
        // Show "Create Plan" button
        addActionButtons([
          { 
            text: '🔧 Planを立てる', 
            className: 'primary', 
            action: () => createPlan(session.id) 
          }
        ]);
      } else if (!session.build) {
        // Plan exists but build not started - show "Execute Build" button
        addActionButtons([
          { 
            text: '🚀 実装を開始 (Build)', 
            className: 'success', 
            action: () => executeBuild(session.id) 
          }
        ]);
      }
    }

    // Add chat message
    function addChatMessage(role, content) {
      const messageEl = document.createElement('div');
      messageEl.className = `chat-message ${role}`;

      const avatar = role === 'user' ? 'U' : '🤖';
      const time = new Date().toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });

      messageEl.innerHTML = `
        <div class="chat-message-avatar">${avatar}</div>
        <div class="chat-message-content">
          <div>${content.replace(/\n/g, '<br>')}</div>
          <div class="chat-message-time">${time}</div>
        </div>
      `;

      chatMessages.appendChild(messageEl);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Add action buttons
    function addActionButtons(buttons) {
      const container = document.createElement('div');
      container.className = 'chat-action-buttons';

      buttons.forEach(btn => {
        const buttonEl = document.createElement('button');
        buttonEl.className = `chat-action-btn ${btn.className}`;
        buttonEl.textContent = btn.text;
        buttonEl.addEventListener('click', btn.action);
        container.appendChild(buttonEl);
      });

      chatMessages.appendChild(container);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Create plan
    async function createPlan(sessionId) {
      try {
        // Disable button
        const buttons = document.querySelectorAll('.chat-action-btn');
        buttons.forEach(btn => {
          btn.disabled = true;
          btn.textContent = 'プラン作成中...';
        });

        const res = await fetch(`${API_BASE_URL}/api/cursor-agent/sessions/${sessionId}/plan`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({})
        });

        if (!res.ok) throw new Error('Failed to create plan');

        const data = await res.json();
        
        // Remove action buttons
        buttons.forEach(btn => btn.parentElement.remove());
        
        // Reload session to update UI (this will show the plan message)
        await loadSession(sessionId);

      } catch (error) {
        console.error('プラン作成エラー:', error);
        addChatMessage('assistant', `❌ プラン作成に失敗しました: ${error.message}`);
        
        // Re-enable buttons
        const buttons = document.querySelectorAll('.chat-action-btn');
        buttons.forEach(btn => {
          btn.disabled = false;
          btn.textContent = '🔧 Planを立てる';
        });
      }
    }

    // Execute build
    async function executeBuild(sessionId) {
      try {
        // Disable button
        const buttons = document.querySelectorAll('.chat-action-btn');
        buttons.forEach(btn => {
          btn.disabled = true;
          btn.textContent = 'ビルド実行中...';
        });

        const res = await fetch(`${API_BASE_URL}/api/cursor-agent/sessions/${sessionId}/build`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({})
        });

        if (!res.ok) throw new Error('Failed to execute build');

        const data = await res.json();
        
        // Remove action buttons
        buttons.forEach(btn => btn.parentElement.remove());
        
        // Reload session to update UI (this will show the build complete message)
        await loadSession(sessionId);

      } catch (error) {
        console.error('ビルド実行エラー:', error);
        addChatMessage('assistant', `❌ ビルド実行に失敗しました: ${error.message}`);
        
        // Re-enable buttons
        const buttons = document.querySelectorAll('.chat-action-btn');
        buttons.forEach(btn => {
          btn.disabled = false;
          btn.textContent = '🚀 実装を開始 (Build)';
        });
      }
    }

    // Get status text
    function getStatusText(status) {
      const statusMap = {
        'planning': '計画中',
        'building': 'ビルド中',
        'completed': '完了',
        'error': 'エラー'
      };
      return statusMap[status] || status;
    }

    // Send chat message
    async function sendChatMessage() {
      const message = chatInput.value.trim();
      if (!message || !currentSessionId) return;

      try {
        // ユーザーメッセージを表示
        addChatMessage('user', message);
        chatInput.value = '';
        chatSendBtn.disabled = true;
        chatInput.disabled = true;

        // 送信中インジケーターを表示
        const thinkingMessageEl = addThinkingMessage();

        const res = await fetch(`${API_BASE_URL}/api/cursor-agent/sessions/${currentSessionId}/chat`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message })
        });

        // 送信中インジケーターを削除
        thinkingMessageEl.remove();

        if (!res.ok) throw new Error('Failed to send message');

        const data = await res.json();
        addChatMessage('assistant', data.response);

      } catch (error) {
        console.error('チャット送信エラー:', error);
        
        // 送信中インジケーターを削除（エラー時）
        const thinkingMessage = document.querySelector('.chat-message.thinking');
        if (thinkingMessage) {
          thinkingMessage.remove();
        }
        
        addChatMessage('assistant', 'エラーが発生しました。もう一度お試しください。');
      } finally {
        chatSendBtn.disabled = false;
        chatInput.disabled = false;
        chatInput.focus();
      }
    }

    // Add thinking message (typing indicator)
    function addThinkingMessage() {
      const messageEl = document.createElement('div');
      messageEl.className = 'chat-message assistant thinking';

      const time = new Date().toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });

      messageEl.innerHTML = `
        <div class="chat-message-avatar">🤖</div>
        <div class="chat-message-content">
          <div class="typing-indicator">
            <span></span>
            <span></span>
            <span></span>
          </div>
          <div class="chat-message-time">${time}</div>
        </div>
      `;

      chatMessages.appendChild(messageEl);
      chatMessages.scrollTop = chatMessages.scrollHeight;
      
      return messageEl;
    }

    // Setup event listeners
    function setupEventListeners() {
      // Sidebar toggle
      sidebarToggle.addEventListener('click', () => {
        sidebar.classList.toggle('collapsed');
        sidebarToggle.textContent = sidebar.classList.contains('collapsed') ? '▶' : '◀';
      });

      // New session
      newSessionBtn.addEventListener('click', () => {
        newSessionModal.classList.remove('hidden');
      });

      closeModal.addEventListener('click', () => {
        newSessionModal.classList.add('hidden');
      });

      cancelBtn.addEventListener('click', () => {
        newSessionModal.classList.add('hidden');
      });

      // Project select
      projectSelect.addEventListener('change', async (e) => {
        const projectId = e.target.value;
        if (!projectId) {
          documentList.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-secondary);">プロジェクトを選択してください</div>';
          createSessionBtn.disabled = true;
          return;
        }

        try {
          const res = await fetch(`${API_BASE_URL}/api/processing/documents?projectId=${projectId}`);
          if (!res.ok) throw new Error('Failed to load documents');
          const data = await res.json();
          documents = data.documents;

          renderDocuments();
          createSessionBtn.disabled = false;
        } catch (error) {
          console.error('ドキュメント読み込みエラー:', error);
          documentList.innerHTML = '<div style="padding: 20px; text-align: center; color: red;">読み込みエラー</div>';
        }
      });

      // Create session
      createSessionBtn.addEventListener('click', async () => {
        const projectId = projectSelect.value;
        if (!projectId) return;

        const selectedDocs = Array.from(documentList.querySelectorAll('input[type="checkbox"]:checked'))
          .map(cb => cb.value);

        try {
          createSessionBtn.disabled = true;
          createSessionBtn.textContent = '作成中...';

          const res = await fetch(`${API_BASE_URL}/api/cursor-agent/sessions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              projectId,
              documentIds: selectedDocs
            })
          });

          if (!res.ok) throw new Error('Failed to create session');

          const data = await res.json();
          currentSessionId = data.session.id;  // 修正: data.session.id を使用

          // Close modal
          newSessionModal.classList.add('hidden');

          // Reload sessions and load new session
          await loadSessions();
          await loadSession(currentSessionId);

        } catch (error) {
          console.error('セッション作成エラー:', error);
          alert('セッションの作成に失敗しました');
        } finally {
          createSessionBtn.disabled = false;
          createSessionBtn.textContent = 'セッション作成';
        }
      });

      // Chat send
      chatSendBtn.addEventListener('click', sendChatMessage);

      // Auto-resize textarea
      chatInput.addEventListener('input', () => {
        chatInput.style.height = 'auto';
        chatInput.style.height = chatInput.scrollHeight + 'px';
      });
    }

    // Render documents
    function renderDocuments() {
      if (documents.length === 0) {
        documentList.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-secondary);">ドキュメントがありません</div>';
        return;
      }

      documentList.innerHTML = '';
      documents.forEach(doc => {
        const item = document.createElement('div');
        item.className = 'document-item';
        item.innerHTML = `
          <input type="checkbox" value="${doc.id}">
          <span class="document-title">${doc.title}</span>
          <span class="document-type">${doc.type}</span>
        `;
        documentList.appendChild(item);
      });
    }

    // Start
    init();
  </script>
</body>
</html>

